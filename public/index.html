<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Hello Virgil</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/3.0.0/antd.min.css">
	<link rel="stylesheet" href="/styles.css">

	<script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
	<script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
	<script crossorigin src="https://unpkg.com/prop-types/prop-types.js"></script>
	<script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
	<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js"></script>
	<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/antd/3.0.0/antd.min.js"></script>
	<script crossorigin src="https://cdn.virgilsecurity.com/packages/javascript/sdk/4.5.1/virgil-sdk.min.js"></script>
</head>
<body>
<div id="root"></div>

<script>
	var VIRGIL_APP_ACCESS_TOKEN = '{{VIRGIL_APP_ACCESS_TOKEN}}';
</script>
<script>
	/*
	* memoize.js
	* by @philogb and @addyosmani
	* with further optimizations by @mathias
	* and @DmitryBaranovsk
	* perf tests: http://bit.ly/q3zpG3
	* Released under an MIT license.
	*/
	function memoize( fn ) {
		return function () {
			var args = Array.prototype.slice.call(arguments),
				hash = "",
				i = args.length;
			var currentArg = null;
			while (i--) {
				currentArg = args[i];
				hash += (currentArg === Object(currentArg)) ?
					JSON.stringify(currentArg) : currentArg;
				fn.memoize || (fn.memoize = {});
			}
			return (hash in fn.memoize) ? fn.memoize[hash] :
				fn.memoize[hash] = fn.apply(this, args);
		};
	}
</script>
<script type="text/babel">
	const { Form, Icon, Input, Button, Select, Avatar, Layout, Menu, message } = window.antd;
	const { Item: FormItem } = Form;
	const { TextArea } = Input;
	const { Option } = Select;
	const { Header, Content, Footer, Sider } = Layout;


	class App extends React.Component {
		state = {
			currentUser: null
		}

		render() {
			if (!this.state.currentUser) {
				return <Auth register={this.register} login={this.login} />
			}

			return <Home user={this.state.currentUser} />;
		}

		register = ({ username, password }) => {
			const key = virgilHelper.createKey();
			const card = virgilHelper.createCardRequest(username, key);

			http.post('/users/', { username, csr: card.export() })
				.then(() => key.save(username, password))
				.then(key => this.setState({ currentUser: { username, key } }))
				.catch(handleError);
		}

		login = ({ username, password }) => {
			return virgilHelper.loadKey(username, password)
				.then(key => this.setState({ currentUser: { username, key } }))
				.catch(handleError);
		}
	}

	// ------------ AUTHENTICATION ------------ //
	class Auth extends React.Component {
		state = {
			isLoggingIn: true
		}

		render() {
			return (
				<Layout className="layout">
					<Header className="auth-header">
						<Logo />
					</Header>
					<Content>
						{
							this.state.isLoggingIn
								? <LoginForm goToRegistration={this.goToRegistration} login={this.props.login} />
								: <RegisterForm goToLogin={this.goToLogin} register={this.props.register}/>
						}
					</Content>
					<AppFooter />
				</Layout>
			);
		}

		goToLogin = () => {
			this.setState({ isLoggingIn: true });
		}

		goToRegistration = () => {
			this.setState({ isLoggingIn: false });
		}
	}

	function RegisterForm(props) {
		return (
			<div>
				<h2 className="auth-title">Sign up to start encrypting and decrypting messages</h2>
				<AuthForm onSubmit={props.register} submitText="Register"/>
				<div className="auth-form-footer">
					<span>Have a key? </span>
					<a href="#" onClick={props.goToLogin}>Sign In</a>
				</div>
			</div>
		);
	}

	function LoginForm(props) {
		return (
			<div>
				<h2 className="auth-title">Sign in to continue encrypting and decrypting messages</h2>
				<AuthForm onSubmit={props.login} submitText="Login"/>
				<div className="auth-form-footer">
					<span>Don't have a key? </span>
					<a href="#" onClick={props.goToRegistration}>Sign Up</a>
				</div>
			</div>
		);
	}

	const AuthForm = Form.create()(class extends React.Component {
		render() {
			const { getFieldDecorator } = this.props.form;
			return (
				<Form onSubmit={this.handleSubmit} className="demo-form">
					<FormItem>
						{getFieldDecorator('username', {
							rules: [{ required: true, message: 'Please enter your username!' }],
						})(
							<Input
								prefix={<Icon type="user" style={{ color: 'rgba(0,0,0,.25)' }} />}
								placeholder="Username"
								autocomplete="username"
							/>
						)}
					</FormItem>
					<FormItem>
						{getFieldDecorator('password', {
							rules: [{ required: true, message: 'Please enter your password!' }],
						})(
							<Input
								prefix={<Icon type="lock" style={{ color: 'rgba(0,0,0,.25)' }} />}
								type="password"
								placeholder="Private Key Password"
								autocomplete="password"
							/>
						)}
					</FormItem>
					<FormItem>
						<Button type="primary" htmlType="submit" className="demo-form-button">
							{this.props.submitText}
						</Button>
					</FormItem>
				</Form>
			);
		}

		handleSubmit = (e) => {
			e.preventDefault();
			this.props.form.validateFields((err, values) => {
				if (!err) {
					this.props.onSubmit(values);
				}
			});
		}
	});

	// ------------ MAIN PAGE ------------ //

	class Home extends React.Component {
		state = {
			selectedTab: 'encrypt'
		}

		render() {
			return (
				<Layout className="layout">
					<Sider className="sidebar">
						<Logo />
						<Menu
							theme="dark"
							mode="inline"
							style={{ lineHeight: '64px' }}
							defaultSelectedKeys={[ this.state.selectedTab ]}
							onSelect={({ key }) => this.setState({ selectedTab: key })}
						>
							<Menu.Item key="encrypt">Encrypt</Menu.Item>
							<Menu.Item key="decrypt">Decrypt</Menu.Item>
						</Menu>
						<div className="sidebar-footer">
							<UserProfile user={this.props.user} />
						</div>
					</Sider>
					<Layout>
						<Content style={{ padding: '0 50px'}}>
							{
								this.state.selectedTab === 'encrypt'
									? <EncryptForm user={this.props.user} />
									: <DecryptForm user={this.props.user} />
							}
						</Content>
						<AppFooter />
					</Layout>
				</Layout>
			);
		}
	}

	function Logo() {
		return (
			<div className="logo">
				<h1>Virgil Hello World</h1>
			</div>
		);
	}

	function UserProfile(props) {
		return (
			props.user &&
			<div className="profile">
				<Avatar icon="user" size="small" />
				<span className="username">{props.user.username}</span>
			</div>
		);
	}

	function AppFooter() {
		return (
			<Footer style={{ textAlign: 'center' }}>
				2017 Virgil Security, Inc.
			</Footer>
		);
	}

	const EncryptForm = Form.create()(class extends React.Component {
		state = {
			users: [],
			ciphertext: ''
		}

		componentDidMount() {
			http.get('/users')
				.then(users => {
					this.setState({ users: users });
				})
				.catch(handleError);
		}

		render() {
			const { getFieldDecorator } = this.props.form;
			const { users, ciphertext } = this.state;
			return (
				<div>
					<Form onSubmit={this.handleSubmit} className="demo-form">
						<FormItem label="Recipients">
							{getFieldDecorator('recipients', {
								rules: [{ required: true, message: 'Please select recipient(s)', type: 'array' }]
							})(
								<Select placeholder="Whom to encrypt the message for" mode="multiple">
									{
										users.map(user => (
											<Option key={user.id} value={user.virgilCardId}>{user.username}</Option>
										))
									}
								</Select>
							)}
						</FormItem>
						<FormItem label="Message">
							{getFieldDecorator('message', {
								rules: [{ required: true, message: 'Please enter the message!' }],
							})(
								<TextArea placeholder="Secret message" autosize={{ minRows: 2, maxRows: 12 }} />
							)}
						</FormItem>
						<FormItem>
							<Button type="primary" htmlType="submit" className="demo-form-button">
								Encrypt
							</Button>
						</FormItem>
						{ ciphertext &&
						<TextArea
							value={ciphertext}
							autosize={{ minRows: 6, maxRows: 12 }}
							readonly
						/>
						}
					</Form>
				</div>
			);
		}

		handleSubmit = (e) => {
			e.preventDefault();
			this.props.form.validateFields((err, values) => {
				if (!err) {
					this.encrypt(values);
				}
			});
		}

		encrypt({ recipients, message }) {
			const virgilCardsPromise = Promise.all(
				recipients.map(recipient => virgilHelper.getCard(recipient))
			);

			return virgilCardsPromise.then(virgilCards => {
				return virgilHelper.encryptForMultiple(message, virgilCards).toString('base64');
			})
				.then(ciphertext => this.setState({ ciphertext }))
				.catch(handleError);
		}
	});

	const DecryptForm = Form.create()(class extends React.Component {
		state = {
			plaintext: ''
		}

		render() {
			const { getFieldDecorator } = this.props.form;
			const { plaintext } = this.state;
			return (
				<div>
					<Form onSubmit={this.handleSubmit} className="demo-form">
						<FormItem label="Ciphertext">
							{getFieldDecorator('ciphertext', {
								rules: [{ required: true, message: 'Please enter the ciphertext!' }],
							})(
								<TextArea
									placeholder="That long base64-encoded string you've got from Encrypt form"
									autosize={{ minRows: 6, maxRows: 12 }}
								/>
							)}
						</FormItem>
						<FormItem>
							<Button type="primary" htmlType="submit" className="demo-form-button">
								Decrypt
							</Button>
						</FormItem>
						{ plaintext &&
						<TextArea
							value={plaintext}
							autosize={{ minRows: 6, maxRows: 12 }}
							readonly
						/>
						}
					</Form>
				</div>
			);
		}

		handleSubmit = (e) => {
			e.preventDefault();
			this.props.form.validateFields((err, values) => {
				if (!err) {
					this.decrypt(values);
				}
			});
		}

		decrypt({ ciphertext }) {
			Promise.resolve()
				.then(() => {
					return this.props.user.key.decrypt(ciphertext).toString('utf8');
				})
				.then(plaintext => this.setState({ plaintext }))
				.catch(e => {
					if (e.code === '90002') {
						return Promise.reject(
							new Error(
								'Unable to decrypt the given data. ' +
								'It hasn\'t been encrypted with your public key.'
							)
						);
					}

					return Promise.reject(e);
				})
				.catch(handleError);
		}
	});

	// ------------ UTILS ------------ //

	const http = (function () {
		function handleResponse(res) {
			if (res.ok) {
				return res.json();
			}

			if (res.status === 400) {
				return res.json()
					.then(data => {
						const error = new Error(data.message);
						error.statusCode = data.statusCode;
						error.name = data.error;

						return Promise.reject(error);
					})
			}

			return Promise.reject(new Error('Unexpected server error'));
		}

		return {
			get(url) {
				return fetch(url)
					.then(handleResponse);
			},

			post(url, data) {
				return fetch(url, {
					method: 'POST',
					body: JSON.stringify(data),
					headers: new Headers({ 'Content-Type': 'application/json' })
				}).then(handleResponse)
			}
		};
	})();

	const virgilHelper = (function () {
		const virgilApi = window.virgil.API({
			accessToken: VIRGIL_APP_ACCESS_TOKEN
		});

		return {
			createKey() {
				return virgilApi.keys.generate();
			},

			loadKey(username, password) {
				return virgilApi.keys.exists(username)
					.then(exists => {
						if (!exists) {
							return Promise.reject(new Error(`A private key for user ${username} does not exist.`));
						}

						return virgilApi.keys.load(username, password)
							.catch(e => {
								if (e.code === '90010') {
									return Promise.reject(
										new Error(
											'Unable to decrypt the private key with the given password. ' +
											'Password is invalid for the given username.'
										)
									);
								}
							});
					});
			},

			createCardRequest(username, virgilKey) {
				return virgilApi.cards.create(username, virgilKey);
			},

			getCard: memoize(cardId => virgilApi.cards.get(cardId)),

			encryptForMultiple(data, recipients) {
				return virgilApi.encryptFor(data, recipients);
			}
		}
	})();

	const handleError = (e) => {
		console.error(e);
		message.error(e.message);
	};

	ReactDOM.render(
		<App />,
		document.getElementById('root')
	);
</script>
</body>
</html>
